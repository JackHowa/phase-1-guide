#!/usr/bin/env ruby
require 'pathname'
require 'json'

#TODO(matt): account for student-handbook. Hemlock?
#TODO(matt): temporarily generate .challenge-list as well?

def build_challenge_json(path)
  repo = File.expand_path(path)
  config_dir = "#{repo}/config"
  glob_pattern = "#{repo}/**/week-*/{monday,tuesday,wednesday,thursday,friday,weekend}.md"
  challenge_pattern = /([^\/]*-challenge)\)/
  challenges = Hash.new do |guide, week|
    guide[week] = Hash.new { |week, day| week[day] = [] }
  end

  Dir.glob(glob_pattern).each do |file|
    path = Pathname.new(file)
    week = path.parent.basename
    day = path.basename(".md")
    matches = path.open {|f| f.read.scan(challenge_pattern).flatten }
    challenges[week][day] += matches
  end

  challenges
end

def flatten_challenge_hash(challenges)
  challenges.values.map(&:values).flatten.uniq.sort
end

if __FILE__ == $0
  challenge_list = build_challenge_json(ARGV[1])

  if ARGV[0] == "--flat"
    flat = flatten_challenge_hash(challenge_list)
    flat << "student-handbook" #Temporary
    STDOUT.puts flat.join("\n")
  elsif ARGV[0] == "--nested"
    STDOUT.puts JSON.pretty_generate(challenge_list)
  end
end
